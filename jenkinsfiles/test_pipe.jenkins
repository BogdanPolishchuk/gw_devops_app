properties([
    parameters([
        gitParameter(branch: '',
                     branchFilter: 'origin/(.*)',
                     defaultValue: 'master',
                     description: '',
                     name: 'BRANCH',
                     quickFilterEnabled: false,
                     selectedValue: 'NONE',
                     sortMode: 'NONE',
                     tagFilter: '*',
                     type: 'PT_BRANCH'),
	string(defaultValue: '8888', description: 'Enter port number', name: 'PORT', trim: false)
    ])
])
node {
    stage("Clean"){
        sh "uptime"
        deleteDir()
    }

    stage("current_path"){
        sh "pwd"
    }
    
    stage("check ports number"){
        sh "echo ${params.PORT}"
    }

    stage("CHECKOUT"){
    
      sh "git clone -b ${params.BRANCH} https://github.com/BogdanPolishchuk/gw_devops_app.git . --depth 1"
    
    }

    stage("BUILD"){
        sh "ls -la ; cd java_app&&mvn clean install"
    }
    
    stage("UPLOAD ARTIFACT"){
        archiveArtifacts artifacts: 'java_app/target/*.jar', onlyIfSuccessful: true
    }

    stage("RENAME"){
        sh "cd /var/lib/jenkins/jobs/gw1/builds/${BUILD_NUMBER}/archive/java_app/target/ ; mv spring-boot-sample-web-ui-2.2.6.RELEASE.jar app-ver.${BUILD_NUMBER}.jar"
    }

    stage("PWD"){
        sh "pwd"
    }

    stage("BUILD Number"){
        sh "echo '    build_number: ${BUILD_NUMBER}' >> ./ansible_roles/group_vars/all.yml"
    }
    
    stage("CHECK FILE"){
        sh "cat ./ansible_roles/group_vars/all.yml"
    }

    stage("ADD HOSTS"){
        sh "cp /hosts.txt ./ansible_roles/hosts.txt"
    }

    stage("CI DEPLOY"){
        sh "ls -lh ; cd ansible_roles&&ansible-playbook service.yml --extra-vars 'port=${params.PORT}'"
    }

    stage("Availability test"){
        sh "sleep 15 ; curl -I http://172.33.33.2:${params.PORT}"
    }
}
	
